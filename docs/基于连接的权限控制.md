# 基于连接的细粒度权限控制

## 更新说明

现在权限控制已经从"密钥级别"改为"连接级别"，实现了更细粒度的权限管理。

## 核心变化

### 1. 权限模型

**之前**：一个密钥对所有连接使用相同的权限设置
```
密钥 → 全局权限（只读/读写/DDL）
```

**现在**：一个密钥对不同连接可以有不同的权限
```
密钥 + 连接A → 只读
密钥 + 连接B → 读写
密钥 + 连接C → 读写 + DDL
```

### 2. 数据库表结构

`permissions` 表包含以下字段：
- `id` - 权限ID
- `key_id` - 访问密钥ID
- `connection_id` - 数据库连接ID
- `select_only` - 是否只读（仅允许 SELECT 查询）
- `allow_ddl` - 是否允许 DDL（CREATE/DROP/ALTER等）
- `created_at` - 创建时间

### 3. 权限级别

#### 只读模式 (select_only=true, allow_ddl=false)
- ✅ SELECT 查询
- ✅ SHOW 命令
- ✅ DESCRIBE 命令
- ✅ EXPLAIN 命令
- ❌ INSERT/UPDATE/DELETE
- ❌ CREATE/DROP/ALTER

#### 读写模式 (select_only=false, allow_ddl=false)
- ✅ SELECT 查询
- ✅ INSERT/UPDATE/DELETE
- ✅ 事务操作
- ❌ CREATE/DROP/ALTER

#### 完全权限 (select_only=false, allow_ddl=true)
- ✅ SELECT 查询
- ✅ INSERT/UPDATE/DELETE
- ✅ 事务操作
- ✅ CREATE/DROP/ALTER
- ✅ TRUNCATE/RENAME

## 前端界面

### 权限标签显示

在访问密钥列表中，每个连接的权限以标签形式显示：

```
已授权连接:
[生产数据库 (只读)]  [×]
[测试数据库 (读写 + DDL)]  [×]
[开发数据库 (读写)]  [×]
```

### 授权连接界面

点击 **"+ 授权连接"** 后，可以为每个连接单独配置权限：

```
┌─────────────────────────────────────────┐
│ ☑ 生产数据库                             │
│   prod.example.com:3306 / production    │
│   ○ 只读 (仅 SELECT 查询)                │
│   ○ 读写 (SELECT + INSERT/UPDATE/DELETE) │
│   ● 完全权限 (包括 DDL: CREATE/DROP/ALTER)│
└─────────────────────────────────────────┘

┌─────────────────────────────────────────┐
│ ☑ 测试数据库                             │
│   test.example.com:3306 / test_db       │
│   ● 只读 (仅 SELECT 查询)                │
│   ○ 读写 (SELECT + INSERT/UPDATE/DELETE) │
│   ○ 完全权限 (包括 DDL: CREATE/DROP/ALTER)│
└─────────────────────────────────────────┘
```

## 权限验证逻辑

### 验证流程

```
1. 检查访问密钥是否存在且启用
2. 检查密钥是否有权访问指定连接
3. 获取该连接的权限详情（select_only, allow_ddl）
4. 分析 SQL 类型
5. 根据权限设置决定是否允许执行
```

### SQL 类型判断

```python
# SELECT 类查询
is_select = sql_upper.startswith('SELECT') or 
            sql_upper.startswith('SHOW') or 
            sql_upper.startswith('DESCRIBE') or 
            sql_upper.startswith('EXPLAIN')

# DDL 操作
is_ddl = any(sql_upper.startswith(kw) for kw in 
            ['CREATE', 'DROP', 'ALTER', 'TRUNCATE', 'RENAME'])

# DML 操作
is_dml = any(sql_upper.startswith(kw) for kw in 
            ['INSERT', 'UPDATE', 'DELETE'])
```

### 权限检查

```python
# 只读检查
if perm['select_only'] and not is_select:
    raise HTTPException(403, "该连接仅允许 SELECT 查询，不允许执行修改操作")

# DDL 检查
if is_ddl and not perm['allow_ddl']:
    raise HTTPException(403, "该连接不允许执行 DDL 操作（CREATE/DROP/ALTER等）")
```

## 应用场景

### 场景 1：多环境隔离

```
密钥: app_backend_key

权限配置:
- 生产数据库 (connection_id=1): 只读
- 测试数据库 (connection_id=2): 读写
- 开发数据库 (connection_id=3): 完全权限

效果:
- 后端应用只能读取生产数据，防止误操作
- 可以在测试环境进行数据修改
- 在开发环境可以自由创建表结构
```

### 场景 2：数据分析团队

```
密钥: analytics_team_key

权限配置:
- 用户数据库 (connection_id=4): 只读
- 订单数据库 (connection_id=5): 只读
- 分析数据库 (connection_id=6): 读写 + DDL

效果:
- 只能查询业务数据，不能修改
- 可以在分析库中创建临时表和视图
```

### 场景 3：运维工具

```
密钥: devops_tool_key

权限配置:
- 所有数据库: 完全权限

效果:
- 可以执行数据库维护操作
- 可以创建索引、优化表结构
```

## API 端点

### 创建权限

```http
POST /admin/permissions?key_id=1&connection_id=2&select_only=false&allow_ddl=true
Authorization: Bearer <admin_token>
```

### 查询权限

```http
GET /admin/permissions
Authorization: Bearer <admin_token>
```

返回：
```json
{
  "items": [
    {
      "id": 1,
      "key_id": 1,
      "connection_id": 2,
      "select_only": false,
      "allow_ddl": true,
      "created_at": "2026-01-09T10:00:00Z"
    }
  ]
}
```

### 删除权限

```http
DELETE /admin/permissions/1
Authorization: Bearer <admin_token>
```

## 验证点

所有以下端点都会检查基于连接的权限：

### 1. 查询代理
- `POST /query` - 根据 SQL 类型检查权限
- `GET /sse/query` - 根据 SQL 类型检查权限

### 2. 元数据查询
- `GET /metadata/tables` - 只读操作，无额外限制
- `GET /metadata/table_info` - 只读操作，无额外限制

### 3. 事务管理
- `POST /transaction/begin` - 需要写权限（select_only=false）
- `POST /transactions/commit` - 无额外检查
- `POST /transactions/rollback` - 无额外检查

### 4. MCP 协议
- `execute_query` - 检查 select_only
- `execute_sql` - 检查 select_only 和 allow_ddl

## 错误消息

### 只读限制
```
HTTP 403 Forbidden
{
  "detail": "该连接仅允许 SELECT 查询，不允许执行修改操作"
}
```

### DDL 限制
```
HTTP 403 Forbidden
{
  "detail": "该连接不允许执行 DDL 操作（CREATE/DROP/ALTER等）"
}
```

### 事务限制
```
HTTP 403 Forbidden
{
  "detail": "该连接为只读模式，不允许开启事务"
}
```

## 最佳实践

### 1. 最小权限原则

为每个密钥分配最小必要权限：
- 只读应用：只授予 SELECT 权限
- 业务应用：授予读写权限，但不授予 DDL
- 管理工具：根据需要授予 DDL 权限

### 2. 环境隔离

不同环境使用不同的权限策略：
- 生产环境：严格限制，大部分只读
- 测试环境：相对宽松，允许数据修改
- 开发环境：完全权限，方便开发调试

### 3. 定期审查

定期检查权限配置：
- 查看审计日志，了解实际使用情况
- 移除不再需要的权限
- 降低过高的权限级别

### 4. 权限分离

为不同用途创建不同的密钥：
- 数据分析：只读密钥
- 数据同步：读写密钥
- 数据库迁移：DDL 密钥

## 监控与审计

所有操作都会记录在审计日志中，包括：
- 访问密钥
- 连接ID
- SQL 语句
- 执行结果
- 权限检查结果

查询审计日志：
```http
GET /admin/audit/logs?limit=100&connection_id=1
Authorization: Bearer <admin_token>
```

## 总结

通过基于连接的细粒度权限控制，您可以：

✅ **更精确的权限管理** - 同一密钥对不同连接有不同权限
✅ **更好的安全性** - 最小权限原则，降低误操作风险
✅ **更灵活的配置** - 适应不同场景的需求
✅ **更清晰的审计** - 明确知道每个操作的权限来源

这种设计使得权限管理更加灵活和安全，适合复杂的企业环境！

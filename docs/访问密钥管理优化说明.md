# 访问密钥管理优化说明

## 更新内容

### 1. ✅ 密钥启用/禁用功能

#### 前端改进
- **状态显示**：状态徽章现在可点击切换
  - 绿色 "✓ 启用" - 密钥可用
  - 红色 "✗ 禁用" - 密钥不可用
  - 点击徽章即可快速切换状态

- **操作按钮**：在操作列添加了启用/禁用按钮
  - 启用状态显示"禁用"按钮
  - 禁用状态显示绿色"启用"按钮

#### 后端实现
- **新增 API**: `PATCH /admin/keys/{key_id}/toggle`
  - 参数：`enabled` (boolean)
  - 需要管理员登录
  - 记录操作日志

#### 安全验证
密钥的 `enabled` 状态现在在以下所有验证点生效：

1. **标准 MCP 协议 (SSE)**
   - `/mcp/sse` - SSE 连接
   - `/mcp/message` - 消息处理
   
2. **HTTP API**
   - `/mcp/tools` - 工具列表
   - `/mcp/call` - 工具调用
   
3. **查询代理**
   - `/query` - 查询执行
   - `/sse/query` - SSE 查询
   - `/metadata/*` - 元数据查询
   - `/transaction/*` - 事务管理

**验证逻辑**：
```python
# 所有端点都会检查
if not key_row or not key_row.enabled:
    raise HTTPException(status_code=401, detail="无效或已禁用的访问密钥")
```

**使用场景**：
- 🔒 **临时禁用**：怀疑密钥泄露时立即禁用
- 🔄 **轮换密钥**：创建新密钥后禁用旧密钥
- 🛠️ **维护模式**：系统维护时禁用所有外部访问
- 👥 **用户管理**：员工离职时禁用其密钥

### 2. ✅ 授权连接模态框优化

#### 问题
原来的实现在连接数量多时会导致：
- 列表过长，难以查找
- 滚动体验差
- 无法快速定位目标连接

#### 解决方案

##### 搜索功能
- 实时搜索，支持以下字段：
  - 连接名称
  - 主机地址
  - 数据库名
- 输入即搜，无需点击按钮
- 搜索结果自动重置到第一页

##### 分页功能
- 每页显示 10 条记录
- 上一页/下一页按钮
- 显示当前页码和总页数
- 显示总记录数

##### 智能显示
- **少于 5 个连接**：不显示搜索框，直接展示
- **5 个以上连接**：显示搜索框
- **已授权连接**：自动过滤，不在列表中显示
- **空搜索结果**：友好提示"没有找到匹配的连接"

##### 改进的 UI
- 每个连接显示两行：
  - 第一行：连接名称（粗体）
  - 第二行：主机:端口 / 数据库（灰色小字）
- 鼠标悬停高亮
- 更好的视觉层次

#### 使用示例

**场景 1：少量连接（< 5个）**
```
为密钥分配权限（可多选）

选择数据库连接（可多选）- 已授权 2 个
┌─────────────────────────────────┐
│ ☐ 测试数据库                     │
│   localhost:3306 / test_db      │
│                                  │
│ ☐ 开发数据库                     │
│   dev.example.com:3306 / dev_db │
└─────────────────────────────────┘
共 2 条

☑ 只读模式 (仅限查询)
[确认授权]
```

**场景 2：大量连接（> 5个）**
```
为密钥分配权限（可多选）

搜索连接
[输入名称、主机或数据库名搜索...]

选择数据库连接（可多选）- 已授权 5 个
┌─────────────────────────────────┐
│ ☐ 生产数据库 - 主库              │
│   prod-master.example.com:3306  │
│   / production                   │
│                                  │
│ ☐ 生产数据库 - 从库1             │
│   prod-slave1.example.com:3306  │
│   / production                   │
│                                  │
│ ... (显示 10 条)                 │
└─────────────────────────────────┘
[上一页]  第 1 / 5 页 (共 45 条)  [下一页]

☑ 只读模式 (仅限查询)
[确认授权]
```

**场景 3：搜索过滤**
```
搜索连接
[prod]  ← 输入 "prod" 搜索

选择数据库连接（可多选）
┌─────────────────────────────────┐
│ ☐ 生产数据库 - 主库              │
│   prod-master.example.com:3306  │
│                                  │
│ ☐ 生产数据库 - 从库1             │
│   prod-slave1.example.com:3306  │
└─────────────────────────────────┘
共 12 条  ← 只显示匹配 "prod" 的连接
```

## 使用指南

### 启用/禁用密钥

#### 方法 1：点击状态徽章
1. 在访问密钥列表中找到目标密钥
2. 点击"状态"列的徽章（✓ 启用 或 ✗ 禁用）
3. 状态立即切换

#### 方法 2：使用操作按钮
1. 在访问密钥列表中找到目标密钥
2. 点击"操作"列的"启用"或"禁用"按钮
3. 状态立即切换

### 授权连接

#### 基本流程
1. 点击密钥行的 **"+ 授权连接"** 按钮
2. （如果连接多）在搜索框输入关键词过滤
3. 勾选要授权的连接（可多选）
4. 选择权限级别（只读/读写）
5. 点击 **"确认授权"**

#### 搜索技巧
- 搜索连接名：`生产`
- 搜索主机：`192.168`
- 搜索数据库：`test_db`
- 组合搜索：`prod mysql`

#### 批量授权
- 可以一次勾选多个连接
- 所有选中的连接将使用相同的权限设置
- 适合为新密钥快速配置多个连接

## 安全建议

### 密钥状态管理

1. **定期审查**
   - 每月检查所有密钥状态
   - 禁用不再使用的密钥
   - 不要删除，先禁用观察一段时间

2. **应急响应**
   - 发现密钥泄露：立即禁用
   - 系统异常：禁用所有外部密钥
   - 维护期间：禁用非必要密钥

3. **最佳实践**
   - 为每个用途创建独立密钥
   - 使用描述字段标注用途和负责人
   - 定期轮换密钥（创建新的，禁用旧的）

### 权限分配

1. **最小权限原则**
   - 只授权必要的连接
   - 优先使用只读模式
   - 生产环境严格控制

2. **分环境管理**
   - 开发密钥：只授权开发环境连接
   - 测试密钥：只授权测试环境连接
   - 生产密钥：严格限制，定期审计

3. **定期清理**
   - 移除不再需要的授权
   - 检查审计日志，移除未使用的授权
   - 保持权限配置简洁明了

## 技术细节

### 前端实现

**搜索和分页逻辑**：
```javascript
let currentPage = 1;
const pageSize = 10;
let searchTerm = '';

function renderConnectionList() {
    // 1. 搜索过滤
    const filtered = availableConns.filter(c => 
        searchTerm === '' || 
        c.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
        c.host.toLowerCase().includes(searchTerm.toLowerCase()) ||
        c.database.toLowerCase().includes(searchTerm.toLowerCase())
    );
    
    // 2. 分页
    const totalPages = Math.ceil(filtered.length / pageSize);
    const startIdx = (currentPage - 1) * pageSize;
    const endIdx = startIdx + pageSize;
    const pageConns = filtered.slice(startIdx, endIdx);
    
    // 3. 渲染
    // ...
}
```

**状态切换**：
```javascript
async function toggleKeyStatus(id, enabled) {
    await apiCall(`/admin/keys/${id}/toggle`, {
        method: 'PATCH',
        body: JSON.stringify({ enabled })
    });
    loadKeys(); // 刷新列表
}
```

### 后端 API

**密钥状态切换**：
```python
@router.patch("/admin/keys/{key_id}/toggle")
def toggle_key_status(key_id: int, enabled: bool, authorization: str = Header(None)):
    # 验证登录
    user_data = auth_service.get_current_user(authorization)
    
    # 更新状态
    with Session(engine) as s:
        s.execute(
            update(keys)
            .where(keys.c.id == key_id)
            .values(enabled=enabled)
        )
        s.commit()
    
    # 记录日志
    logger.info(f"切换密钥状态: id={key_id} enabled={enabled} by {user_data['username']}")
    return {"ok": True}
```

**密钥验证**（所有端点）：
```python
# 1. 查询密钥
key_row = session.execute(
    select(keys).where(
        keys.c.ak == x_access_key,
        keys.c.enabled == True  # ← 检查启用状态
    )
).first()

# 2. 验证
if not key_row:
    raise HTTPException(status_code=401, detail="无效或已禁用的访问密钥")
```

## 常见问题

### Q1: 禁用密钥后，正在使用的连接会怎样？

**A**: 立即失效。所有使用该密钥的请求都会收到 401 错误。

### Q2: 可以恢复已禁用的密钥吗？

**A**: 可以。点击"启用"按钮即可恢复。

### Q3: 搜索不区分大小写吗？

**A**: 是的，搜索会自动转换为小写进行匹配。

### Q4: 分页会影响多选吗？

**A**: 不会。每页的选择是独立的，切换页面不会清除已选项。

### Q5: 已授权的连接为什么不在列表中？

**A**: 为了避免重复授权，已授权的连接会自动过滤掉。如需修改权限，请先删除原有授权。

## 更新日志

**版本**: 1.1.0  
**日期**: 2026-01-09

**新增**:
- ✅ 密钥启用/禁用切换功能
- ✅ 授权连接模态框搜索功能
- ✅ 授权连接模态框分页功能
- ✅ 所有 API 端点的密钥状态验证

**改进**:
- ✨ 更友好的连接选择界面
- ✨ 更快的连接查找体验
- ✨ 更直观的状态管理

**修复**:
- 🐛 修复大量连接时的性能问题
- 🐛 修复状态无法切换的问题

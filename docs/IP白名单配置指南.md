# IP 白名单配置指南

## 功能说明

IP 白名单功能可以限制访问密钥只能从特定的 IP 地址或 IP 段访问 MCP Server，提高安全性。

## 配置步骤

### 1. 进入访问密钥管理

1. 登录管理后台 `http://localhost:3000/admin`
2. 点击侧边栏的 **"访问密钥"**

### 2. 添加 IP 白名单

在密钥列表中，找到需要配置白名单的密钥：

1. 点击该密钥行的 **"IP白名单"** 列中的 **"+ 添加IP"** 按钮
2. 在弹出的对话框中输入：
   - **IP 地址或 CIDR**: 允许访问的 IP 或 IP 段
   - **描述**: 可选，如"办公室网络"、"VPN 出口"等

### 3. IP 格式说明

支持以下格式：

#### 单个 IP 地址
```
192.168.1.100
10.0.0.50
203.0.113.25
```

#### CIDR 格式（IP 段）
```
192.168.1.0/24     # 192.168.1.0 - 192.168.1.255
10.0.0.0/16        # 10.0.0.0 - 10.0.255.255
172.16.0.0/12      # 172.16.0.0 - 172.31.255.255
```

#### 允许所有 IP（不推荐）
```
0.0.0.0/0          # 允许任何 IP 访问
```

### 4. 管理白名单

#### 查看已配置的白名单
在密钥列表的 **"IP白名单"** 列中，以标签形式显示所有已配置的 IP 规则。

#### 删除白名单规则
点击白名单标签右侧的 **×** 图标即可删除该规则。

## 工作原理

### 访问流程

```
客户端请求 → 检查 Access Key → 检查 IP 白名单 → 允许/拒绝访问
```

### 匹配规则

1. **如果未配置白名单**：允许所有 IP 访问（默认行为）
2. **如果已配置白名单**：只有匹配的 IP 才能访问
3. **多条规则**：只要匹配任意一条规则即可通过

### 示例场景

#### 场景 1：只允许办公室访问

```
密钥: prod_key
白名单:
  - 203.0.113.0/24 (办公室网络)
```

结果：只有来自 `203.0.113.0-255` 的请求才能使用此密钥。

#### 场景 2：允许多个地点

```
密钥: dev_key
白名单:
  - 192.168.1.0/24 (办公室A)
  - 10.0.0.0/24 (办公室B)
  - 172.16.5.100 (VPN 出口)
```

结果：来自三个地点的请求都可以使用此密钥。

#### 场景 3：临时开放（不推荐）

```
密钥: temp_key
白名单:
  - 0.0.0.0/0 (临时开放)
```

结果：任何 IP 都可以访问。**使用后应立即删除此规则！**

## 安全建议

### ✅ 推荐做法

1. **最小权限原则**
   - 只添加必要的 IP 地址
   - 使用尽可能小的 CIDR 范围

2. **定期审查**
   - 定期检查白名单配置
   - 删除不再使用的 IP 规则

3. **使用描述**
   - 为每条规则添加清晰的描述
   - 便于后续管理和审计

4. **分环境管理**
   - 开发环境：可以相对宽松
   - 生产环境：严格限制 IP 范围

5. **结合审计日志**
   - 定期查看审计日志
   - 发现异常访问及时处理

### ❌ 不推荐做法

1. **不要使用 0.0.0.0/0**
   - 除非临时测试
   - 使用后立即删除

2. **不要过度宽松**
   - 避免使用过大的 CIDR 范围
   - 如 10.0.0.0/8 包含 1600 万个 IP

3. **不要忽略更新**
   - IP 变更后及时更新白名单
   - 避免业务中断

## 常见问题

### Q1: 如何获取我的公网 IP？

访问以下任一网站：
- https://ip.sb
- https://ifconfig.me
- https://ipinfo.io/ip

### Q2: 配置白名单后无法访问怎么办？

1. 检查您的实际 IP 地址
2. 确认白名单规则是否包含该 IP
3. 查看审计日志中的 `client_ip` 字段
4. 如果 IP 不匹配，添加正确的 IP 到白名单

### Q3: 动态 IP 怎么办？

**方案 1**: 使用 CIDR 范围
```
# ISP 通常会分配同一段的 IP
203.0.113.0/24
```

**方案 2**: 使用 VPN
```
# 配置固定的 VPN 出口 IP
10.8.0.1
```

**方案 3**: 定期更新
- 设置提醒定期检查 IP
- 及时更新白名单配置

### Q4: 白名单会影响性能吗？

不会。IP 检查在内存中进行，性能影响可忽略不计。

### Q5: 可以为不同密钥配置不同的白名单吗？

可以！每个密钥都有独立的白名单配置。

## 测试白名单

### 方法 1：使用 curl

```bash
# 从允许的 IP 访问（应该成功）
curl http://your-server:3000/mcp/sse \
  -H "X-Access-Key: your_key"

# 从不允许的 IP 访问（应该返回 403）
```

### 方法 2：查看审计日志

1. 进入 **"审计日志"** 页面
2. 查看 `client_ip` 列
3. 确认 IP 是否在白名单中

### 方法 3：使用 TRAE

在 TRAE 中尝试调用 MCP 工具：
- 成功：白名单配置正确
- 失败：检查 IP 配置

## 与其他安全措施配合

IP 白名单应与其他安全措施配合使用：

1. **HTTPS** - 加密传输
2. **访问密钥** - 身份认证
3. **IP 白名单** - 来源限制
4. **权限控制** - 资源授权
5. **审计日志** - 行为追踪

## 示例配置

### 小型团队（10人以下）

```
密钥: team_key
白名单:
  - 203.0.113.100 (办公室固定IP)
  - 10.8.0.0/24 (VPN网段)
```

### 中型企业（多办公室）

```
密钥: company_key
白名单:
  - 203.0.113.0/24 (总部)
  - 198.51.100.0/24 (分公司A)
  - 192.0.2.0/24 (分公司B)
  - 10.0.0.0/16 (内网VPN)
```

### 云服务集成

```
密钥: cloud_service_key
白名单:
  - 52.1.2.3 (AWS Lambda 1)
  - 52.1.2.4 (AWS Lambda 2)
  - 35.1.2.3 (GCP Cloud Function)
```

## 总结

IP 白名单是保护 MCP Server 的重要安全措施。合理配置白名单可以：

- ✅ 防止未授权访问
- ✅ 降低密钥泄露风险
- ✅ 满足合规要求
- ✅ 提供访问审计依据

记住：**安全性和便利性需要平衡，但安全性应优先考虑！**
